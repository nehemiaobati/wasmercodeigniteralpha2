# CodeIgniter 4 Development & Deployment Rules

This document outlines the mandatory architectural standards, security mandates, and development workflow for this CodeIgniter 4 application. Adherence to these rules is required to ensure a maintainable, secure, and high-performance codebase.

---

## Part 1: Architectural & Naming Conventions

All code must strictly adhere to the CodeIgniter 4 architecture and the following conventions to maintain consistency and predictability across the application.

### 1.1. File Naming Conventions

- **Controllers:** `PascalCaseController.php` (e.g., `UserController.php`). Exception: `BaseController.php`.
- **Models:** `PascalCaseModel.php` (e.g., `UserModel.php`).
- **Entities:** `PascalCase.php` (e.g., `User.php`).
- **Libraries/Services:** `PascalCaseService.php` (e.g., `PaymentService.php`).
- **Views:** Grouped in a `lowercase` subdirectory named after the controller. File names must be `snake_case.php` (e.g., `app/Views/user/profile_view.php`).
- **Migrations & Seeds:** Use the timestamp-prefixed, `PascalCase` format generated by `php spark`.

### 1.2. Component-Specific Rules

- **Controllers (`app/Controllers/`):**
    - **Role:** Orchestrate application flow.
    - Keep controllers lean, focused on processing HTTP requests and returning responses.
    - Delegate all business logic to Models or Libraries/Services.

- **Models (`app/Models/`):**
    - **Role:** Manage all database interactions.
    - Use Models, the Query Builder, or Entities for data access.
    - Never place direct database queries in Controllers.
    - Import models via `use` and instantiate with their short class name (e.g., `new UserModel()`).

- **Views (`app/Views/`):**
    - **Role:** Handle presentation logic only.
    - Avoid complex PHP logic; focus on displaying data.
    - Escape all dynamic data with `esc()` to prevent Cross-Site Scripting (XSS) attacks.
    - Use View Layouts for page structure and View Cells for reusable components.
    - **No CDATA tags should be used in views.**

- **Routing (`app/Config/Routes.php`):**
    - **Role:** Define the application's URL structure.
    - All routes must be explicitly defined and named using the `['as' => 'route.name']` option for stable URL generation.
    - Use `url_to('route.name')` in Views and `redirect()->to(url_to('route.name'))` in Controllers. Do not use hardcoded URL paths.

- **Database (`app/Database/`):**
    - **Role:** Define and manage the database schema and initial data.
    - All schema changes must be managed via Migrations.
    - Initial or test data should be handled by Seeders.

- **Libraries/Services (`app/Libraries/`, `app/Config/Services.php`):**
    - **Role:** House reusable, high-level application logic.
    - Register classes as Services in `app/Config/Services.php` to ensure they are easily testable and managed by the framework.

### 1.3. Dynamic Responses & Flash Messaging

This pattern (Post/Redirect/Get) is mandatory for all form submissions to prevent duplicate submissions on page refresh.

1.  **Controller Actions:**
    - Action methods (e.g., `create()`, `generate()`) must process the request, then store all response data (status messages, results) in the session via `session()->setFlashdata()` or a redirect's `with()` method.
    - Conclude by redirecting, typically using `return redirect()->back()->withInput()`. **Directly rendering a view from a POST action is forbidden.**

2.  **View Display:**
    - The controller method displaying the view (e.g., `index()`) must retrieve all flash data from the session and pass it to the view.
    - Status messages (`success`, `error`, etc.) must be rendered exclusively through the `app/Views/partials/flash_messages.php` partial.
    - The primary `result` of an action is rendered in the main content area of the specific view.

3.  **Standardized Flashdata Keys:**
    - Use these keys for consistency: `success`, `error`, `warning`, `info`, `errors`, `result`.

---

## Part 2: Coding, Security, & Performance

This section defines the standards for code quality, security hardening, and application performance.

### 2.1. Code Standards
- **PSR-12 Compliance:** All PHP code must adhere to the **PSR-12** coding standard.
- **Modern PHP:** Use modern language features, including strict types (`declare(strict_types=1);`), typed properties, and return type declarations.
- **Framework First:** Prioritize built-in CodeIgniter functions and libraries over custom implementations.
- **API Standardization:** Use CodeIgniter’s `API Response Trait` for standardizing all API endpoint responses.
- **Static Analysis Compliance:** To aid static analysis tools and prevent false positives with CodeIgniter’s Entities, add PHPDoc type hints (`/** @var ClassName|null $variable */`) within methods in Models and Controllers immediately before a variable is assigned the result of a framework method (e.g., `find()`, `first()`).

### 2.2. Documentation & Commenting Standards
Adherence to the PHPDoc standard is mandatory for all code constructs to ensure clarity, maintainability, and compatibility with IDEs and static analysis tools. This is a non-negotiable standard.

- **Class DocBlocks:** Every class MUST have a PHPDoc block that includes:
    - A short, one-line summary of the class's purpose.
    - A longer, more detailed description if necessary.
    - For Entities, a full list of `@property` tags defining its data map and types to assist static analysis.

- **Property DocBlocks:** All `public` and `protected` class properties MUST have a `@var` tag defining their type and a brief description.

- **Method DocBlocks:** All `public` and `protected` methods, including constructors, MUST have a complete PHPDoc block. This block is required even if the method has no parameters or return values. The block must include:
    - A short, one-line summary of the method's function.
    - A longer, more detailed description if the method's logic is complex.
    - An `@param` tag for every parameter, including its type, name (e.g., `$userId`), and a clear description.
    - A `@return` tag specifying the exact return type (e.g., `string`, `bool`, `void`, `RedirectResponse`) and a description of what is being returned. A method with no return value must be documented with `@return void`.
    - A `@throws` tag for any specific exceptions the method is expected to throw.

- **Clarity and Precision:** All comments must be direct, accurate, and professional. Placeholder comments (e.g., `// TODO`), redundant comments (e.g., `// increments i`), or conversational notes are forbidden in production code.

### 2.3. Security Mandates
- **CSRF Protection:** Must be enabled globally to protect against cross-site request forgery attacks.
- **Content Security Policy (CSP):** Must be enabled and configured to mitigate injection attacks.
- **Database:** Use the Query Builder or prepared statements for all queries to prevent SQL injection. Raw queries are forbidden.
- **Validation:** Validate all user-provided data (`$GET`, `$POST`, etc.) with the Validation library before processing.
- **Output Escaping:** Escape all data rendered in HTML with `esc()` to prevent XSS attacks.
- **Secure Cookies & Sessions:** In production, set `cookie.secure` and `cookie.httponly` to `true`. Store session data in a database for improved security.
- **Throttler:** Enable on authentication, password reset, and other sensitive routes to prevent brute-force attacks.

### 2.4. Performance Optimization
- **Disable Auto-Routing:** Set `$autoRoute = false` if all routes are explicitly defined, avoiding unnecessary file system scans.
- **Caching:** Enable and configure a production-ready caching driver (e.g., Redis, Memcached) for frequently accessed data.
- **Optimization Command:** Use `php spark optimize` in the deployment script to build a cached version of the autoloader and configuration.
- **Efficient Queries:** Optimize database queries by selecting only necessary columns and using pagination instead of `findAll()` for large datasets.

### 2.5. Error Handling & Logging
- **Production Error Display:** Disable detailed error reporting to the browser in production (`display_errors = 0`).
- **Exception Logging:** Enable exception logging by setting `$log = true` in `app/Config/Exceptions.php`.
- **Log Level:** Set the production logging threshold to an appropriate level (e.g., 4 for runtime errors) in `app/Config/Logger.php`.
- **Dependency Checks:** When a feature requires a specific PHP extension (e.g., `bcmath`), programmatically check if it's loaded with `extension_loaded()` and log a descriptive error if it's missing.
- **Dual Logging Strategy:** The application must employ a dual logging strategy:
    - **Developer Logs (Raw):** Use the built-in `log_message()` helper for all system-level events, errors, and debugging information. These logs are for developer use only and are stored in `writable/logs/`.
    - **User-Facing Notifications (End-User Log):** Use session flash messages (`session()->setFlashdata()`) to communicate the outcome of user actions (e.g., success, error, info). These messages serve as a temporary, user-visible log of events and must be rendered through the `app/Views/partials/flash_messages.php` partial.

---

## Part 3: Deployment & Environment

These rules govern the configuration and deployment of the application to a live server.

### 3.1. Environment Configuration (`.env`)
- **Production Mode:** Set `CI_ENVIRONMENT` to `production`.
- **Protect Credentials:** The production `.env` file must never be committed to version control. Use a template (`env`) for guidance.
- **Centralized Variables:** Define all environment-specific variables (database credentials, API keys) in `.env` and access them via `env()`.
- **Base URL:** Always set `app.baseURL` with a trailing slash (e.g., `https://example.com/`).

### 3.2. Web Server & Filesystem
- **Public Document Root:** The web server's document root must point to the project's `/public` directory. This is a critical security measure to prevent direct web access to application source code.
- **Directory Permissions:** The `app`, `system`, and `writable` directories must reside outside the web-accessible document root. The web server user requires write permissions only on the `writable` directory.
- **Clean Production Server:** Remove development-only files and directories (`tests/`, `phpunit.xml.dist`, `spark`) from the production server.

### 3.3. Dependency Management
- **Production Dependencies:** Before deployment, run `composer install --no-dev --optimize-autoloader` to install only production dependencies and create an optimized class map.

---

## Part 4: AI Agent Workflow

This section provides a strict protocol for any AI agent modifying the codebase.

1.  **Analyze Request:** Deconstruct user requests into logical, sequential file modifications that align with these rules.
2.  **Propose Changes:** Verbally state the intended modifications and list all affected files before generating code.
3.  **Adhere to Rules:** All modifications must respect every principle outlined in this document without exception.
4.  **File Generation:** Use `php spark make:*` commands to generate new boilerplate files (Controllers, Models, etc.). Manual creation is forbidden. Do not alter the structure of generated boilerplate.
5.  **File Modification:** When updating a file, specify its full path from the project root and provide the complete, updated file content. Partial code snippets are not acceptable.
6.  **Final Confirmation:** Confirm that all changes have been applied in accordance with these rules before concluding the task.

---

## Part 5: Front-End & UI/UX Standards

This section defines the visual and structural standards for all user-facing views to ensure a consistent, responsive, and professional user experience.

### 5.1. Core Framework & Layout
- **Bootstrap 5:** The application MUST use Bootstrap 5 as its foundational CSS framework.
- **Default Layout:** All standard application views MUST extend the main layout file located at `app/Views/layouts/default.php`. Creating standalone HTML pages is forbidden to maintain header, footer, and style consistency.

### 5.2. Theming and Styling
- **Theme:** The application follows a light, clean, and modern theme. The primary color palette and typography are defined in `app/Views/layouts/default.php` and should be referenced via CSS variables (e.g., `var(--primary-color)`).
- **Global Styles:** Styles that apply to multiple pages (e.g., pagination, buttons, cards) MUST be centralized in the main layout file (`app/Views/layouts/default.php`) to ensure consistency and reduce code duplication.
- **Page-Specific Styles:** CSS that is unique to a single page SHOULD be placed within a `<?= $this->section('styles') ?>` block in the respective view file.

### 5.3. Component Consistency
- **Standard Components:** Use standard Bootstrap 5 components for all common UI elements to ensure a predictable user interface.
    - **Cards:** Use the `.card` class with a consistent style (`border-radius: 0.75rem`, `box-shadow`, `border: none`).
    - **Forms:** Use `.form-floating` for all input fields to provide a modern, uniform appearance.
    - **Buttons:** Use the standard `.btn` classes (e.g., `.btn-primary`, `.btn-outline-secondary`).
- **Responsiveness:** All views must be fully responsive and tested on common device breakpoints (mobile, tablet, desktop). Use Bootstrap's grid system (`.row`, `.col-*`) to create fluid layouts.

### 5.4. Dynamic URL Generation in JavaScript
- When making AJAX/fetch requests from client-side JavaScript, avoid hardcoding URLs. If `url_to()` cannot be used directly in the script, construct the URL dynamically. For AJAX calls that are blocked by CORS policies, prefer using `window.location.origin` to build the base path instead of relying on `url_to()` rendered into a data attribute, as this can be more robust in complex hosting environments. Example: `const uploadUrl = \`${window.location.origin}/gemini/upload-media\`;`.

---
## URL References

   Application Structure: https://codeigniter.com/userguide/concepts/structure.html
   API Responses: https://codeigniter.com/userguide/outgoing/apiresponses.html
   Caching: https://codeigniter.com/userguide/libraries/caching.html
   CLI Generators: https://codeigniter.com/userguide/cli/cligenerators.html
   Configuration: https://codeigniter.com/userguide/general/configuration.html
   Content Security Policy (CSP): https://codeigniter.com/userguide/outgoing/csp.html
   Controllers: https://codeigniter.com/userguide/incoming/controllers.html
   Deployment: https://codeigniter.com/userguide/installation/deployment.html
   Entities: https://codeigniter.com/userguide/models/entities.html
   Environments: https://codeigniter.com/userguide/general/environments.html
   Error Handling: https://codeigniter.com/userguide/general/errors.html
   Filters: https://codeigniter.com/userguide/incoming/filters.html
   Helpers: https://codeigniter.com/userguide/general/helpers.html
   Localization: https://codeigniter.com/userguide/outgoing/localization.html
   Logging: https://codeigniter.com/userguide/general/logging.html
   Migrations: https://codeigniter.com/userguide/dbmgmt/migration.html
   Models: https://codeigniter.com/userguide/models/model.html
   Modules: https://codeigniter.com/userguide/general/modules.html
   PSR Standards: https://codeigniter.com/userguide/intro/psr.html
   Query Builder: https://codeigniter.com/userguide/database/querybuilder.html
   Routing: https://codeigniter.com/userguide/incoming/routing.html
   Security: https://codeigniter.com/userguide/libraries/security.html
   Seeding: https://codeigniter.com/userguide/dbmgmt/seeding.html
   Services: https://codeigniter.com/userguide/concepts/services.html
   Sessions: https://codeigniter.com/userguide/libraries/sessions.html
   Testing: https://codeigniter.com/userguide/testing/index.html
   Throttler: https://codeigniter.com/userguide/libraries/throttler.html
   Validation: https://codeigniter.com/userguide/libraries/validation.html
   View Cells: https://codeigniter.com/userguide/outgoing/viewcells.html
   View Layouts: https://codeigniter.com/userguide/outgoing/viewlayouts.html